apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: check-resource-configuration
  annotations:
    policies.kyverno.io/title: Check resource configuration
    policies.kyverno.io/category: Other
    policies.kyverno.io/severity: medium
    kyverno.io/kyverno-version: 1.11.4 
    kyverno.io/kubernetes-version: "1.27"     
    policies.kyverno.io/subject: Deployment, Pod, VerticalPodAutoscaler
    policies.kyverno.io/description: >-
      Policy to check if the resource allocation is within the lower and upperbound of the VPA.
spec:
  validationFailureAction: Audit
  background: false
  rules:
    - name: check-resource-configuration
      match:
        any:
        - resources:
            kinds:
              - Deployment
              - Pod
      preconditions:
        all:
        - key: "{{ time_diff(time_parse('2006-01-02T15:04:05Z07:00','{{ creationTimestamp }}'), time_parse('2006-01-02T15:04:05Z07:00','{{ time_now() }}')) }}"
          operator: LessThanOrEquals
          value: "168h"
        - key: "{{ OffMode }}"
          operator: Equals
          value: "Off"
      context:
        - name: vpaList
          apiCall:
            urlPath: "/apis/autoscaling.k8s.io/v1/namespaces/{{request.object.metadata.namespace}}/verticalpodautoscalers"
            jmesPath: "items[?spec.targetRef.name == '{{ request.object.metadata.name }}']"
        - name: lowerBoundCpu
            variable: "{{ vpaList }}"
            jmesPath: "status.recommendation.containerRecommendations[].lowerBound.cpu"
        - name: lowerBoundMemory
          apiCall:
            variable: "{{ vpaList }}"
            jmesPath: "status.recommendation.containerRecommendations[].lowerBound.memory"
        - name: upperBoundCpu
          apiCall:
            variable: "{{ vpaList }}"
            jmesPath: "status.recommendation.containerRecommendations[].upperBound.cpu"
        - name: upperBoundMemory
          apiCall:
            variable: "{{ vpaList }}"
            jmesPath: "status.recommendation.containerRecommendations[].upperBound.memory"
        - name: creationTimestamp
          apiCall:
            variable: "{{ vpaList }}"
            jmesPath: "metadata.creationTimestamp[] | [0]"
        - name: OffMode
          apiCall:
            variable: "{{ vpaList }}"
            jmesPath: "spec.updatePolicy.updateMode[] | [0]"
      validate:
        message: >-
          Workload '{{request.object.kind}}/{{request.object.metadata.name}}' 
          requires a matching VerticalPodAutoscaler (VPA) in the 
          '{{request.object.metadata.namespace}}' namespace.
        foreach:
        - list: request.object.spec.template.spec.containers[]
          deny:
            conditions:
              all:
              - key: "{{ element.resources.requests.cpu }}" 
                operator: LessThan
                value: "{{ lowerBoundCpu }}"
              - key: "{{ element.resources.requests.cpu }}" 
                operator: GreaterThan
                value: "{{ upperBoundCpu }}"
              - key: "{{ element.resources.requests.memory }}"
                operator: LessThan
                value: "{{ lowerBoundMemory }}"
              - key: "{{ element.resources.requests.memory }}"
                operator: GreaterThan
                value: "{{ upperBoundMemory }}"
